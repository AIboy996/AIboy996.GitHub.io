---
tags:
- Leetcode
include:
- math
---

# [æ’é˜Ÿä¸Šç”µæ¢¯](https://codeforces.com/problemset/problem/518/D/)

$n$ä¸ªäººæ’é˜Ÿä¸Šç”µæ¢¯ï¼Œæ¯ä¸€ç§’é’Ÿéƒ½æœ‰ä¸€ä¸ªäººç«™åœ¨ç”µæ¢¯å‰ï¼Œä»¥$p$çš„æ¦‚ç‡ä¸Šç”µæ¢¯ï¼Œ$1-p$çš„æ¦‚ç‡åœæ»ä¸å‰ã€‚

æ±‚$t$ç§’é’Ÿä¹‹åï¼Œä¸Šç”µæ¢¯äººæ•°çš„æœŸæœ›å€¼ã€‚

## æ¡ä»¶æ¦‚ç‡é€’æ¨

æ˜¾ç„¶ï¼Œå¦‚æœ$t\le n$ï¼Œä¸€å…±åªæœ‰$t$ç§’é’Ÿä¸å¤Ÿ$n$ä¸ªäººéƒ½èµ°å®Œï¼Œé‚£ä¹ˆæ¯ä¸€ç§’éƒ½æœ‰äººåœ¨ç”µæ¢¯å‰ç­‰å¾…ã€‚é‚£ä¹ˆä¸Šç”µæ¢¯çš„äººæ•°å°±æ˜¯ä¸€ä¸ªäºŒé¡¹åˆ†å¸ƒ$B(t, p)$ï¼Œè¿™æ—¶å€™ä¸Šç”µæ¢¯çš„äººæ•°æœŸæœ›ä¸ºï¼š$pt$ã€‚

ä¸‹é¢æˆ‘ä»¬åªè€ƒè™‘$t\gt n$çš„æƒ…å†µï¼Œè¿™æ—¶å€™å°±ä¸ä¸€å®šæ¯ä¸€ç§’é’Ÿéƒ½æœ‰äººåœ¨ç”µæ¢¯å‰ç­‰å¾…äº†ã€‚æˆ‘ä»¬è®¾éšæœºå˜é‡$X_t$è¡¨ç¤º$t$ç§’é’Ÿä¸Šç”µæ¢¯çš„äººæ•°ã€‚

é‚£ä¹ˆå¯¹äº$1\le k \le n-1$æ˜¾ç„¶æœ‰æ¡ä»¶æ¦‚ç‡å…¬å¼ï¼š
$$
\begin{aligned}
&P(X_t = k) \\\\
= &P(X_t = k \mid X_{t-1}=k)P(X_{t-1}=k) \\\\
 &+ P(X_t = k \mid X_{t-1}=k-1)P(X_{t-1}=k-1)\\\\
= &(1-p)P(X_{t-1}=k) + pP(X_{t-1}=k-1)
\end{aligned}
$$

> æ³¨æ„ä¸Šè¿°å…¬å¼å¯¹$k=0,n$çš„æƒ…å†µä¸æˆç«‹

$k=0$çš„æƒ…å†µæ¯”è¾ƒç®€å•ï¼š
$$
P(X_t = 0) = (1-p)^t
$$
$k=n$çš„æƒ…å†µè¾ƒä¸ºç‰¹æ®Šï¼Œå› ä¸ºåç»§æ— äººï¼Œæ‰€ä»¥ä¸éœ€è¦$1-p$è¿™ä¸ªå› å­äº†ï¼š
$$
P(X_t = n) = P(X_{t-1}=n) + pP(X_{t-1}=n-1)
$$

### ä»£ç 

ä¸Šé¢çš„æ¡ä»¶æ¦‚ç‡å…¬å¼ç”¨dpæ•°ç»„å†™å‡ºæ¥å°±æ˜¯ï¼š

```python
n, p, t = input().split()
n = int(n)
p = float(p)
t = int(t)
if t <= n:
    print(t * p)
else:
    dp = [[0] * (n + 1) for _ in range(t + 1)]
    dp[0][0] = 1.0
    for i in range(1, t + 1):
        dp[i][0] = dp[i - 1][0] * (1 - p)
        for j in range(1, n):
            dp[i][j] = dp[i - 1][j - 1] * p + dp[i - 1][j] * (1 - p)
        dp[i][n] = dp[i - 1][n - 1] * p + dp[i - 1][n]
    # æ±‚æœŸæœ›
    print(sum(k * dp[t][k] for k in range(n + 1)))
```

å…¶ä¸­`dp[i][j]`ä»£è¡¨$j$ç§’é’Ÿæœ‰$i$ä¸ªäººä¸Šç”µæ¢¯çš„æ¦‚ç‡ã€‚

## ç›´æ¥æ±‚æœŸæœ›

åˆ©ç”¨å‰é¢çš„æ¦‚ç‡é€’æ¨å¼æˆ‘ä»¬å¯ä»¥æ±‚ä¸€æ±‚æœŸæœ›ï¼š

$$
\begin{aligned}
&E(X_t)\\\\
= & \sum_{k=0}^n kP(X_t=k)\\\\
= & \sum_{k=1}^n kP(X_t=k)\\\\
= & \sum_{k=1}^n k\left[(1-p)P(X_{t-1}=k)+pP(X_{t-1}=k-1)\right] + npP(X_{t-1}=n)\\\\
= & {\color{red}(1-p)\sum_{k=1}^n kP(X_{t-1}=k)} + p\sum_{k=1}^n kP(X_{t-1}=k-1) + npP(X_{t-1}=n)\\\\
= & {\color{red}(1-p)E(X_{t-1})} + p\sum_{k=1}^n (k-1)P(X_{t-1}=k-1)+ npP(X_{t-1}=n)\\\\
&+ p\sum_{k=1}^n P(X_{t-1}=k-1)\\\\
= &(1-p)E(X_{t-1})+p\sum_{k=1}^{n+1} (k-1)P(X_{t-1}=k-1) + p\sum_{k=1}^n P(X_{t-1}=k-1)\\\\
= & (1-p)E(X_{t-1}) + pE(X_{t-1}) + p (1-P(X_{t-1}= n))\\\\
= & E(X_{t-1}) + p(1-P(X_{t-1}= n))
\end{aligned}
$$

å®é™…ä¸Šï¼Œè¿™ä¸ªå…¬å¼ä¸å¿…å¦‚æ­¤éº»çƒ¦ä¹Ÿå¯ä»¥å¾—åˆ°ã€‚

ä¸éš¾å‘ç°ï¼š
$$
X_t = X_{t-1} + \mathcal{1}(X_{t-1}\ne n) \mathcal{1}(Y=1)
$$
å…¶ä¸­$Y$æ˜¯å‚æ•°ä¸º$p$çš„0-1éšæœºå˜é‡ï¼Œä»£è¡¨$t-1$æ—¶å€™ä¹‹åçš„é‚£ä¸€ç§’æ˜¯å¦æœ‰äººè¿›å…¥ç”µæ¢¯, $\mathcal{1}(\cdot)$æ˜¯ç¤ºæ€§å‡½æ•°ã€‚

ä¸¤ä¾§æ±‚æœŸæœ›å³å¯å¾—åˆ°ï¼š
$$
E(X_t) = E(X_{t-1}) + E(\mathcal{1}(X_{t-1}\ne n) \mathcal{1}(Y=1))
$$

å…¶ä¸­
$$
\begin{aligned}
&E(\mathcal{1}(X_{t-1}\ne n) \mathcal{1}(Y=1)) \\\\
= &P(Y=1, X_{t-1}\ne n)\\\\
= &P(Y=1 \mid X_{t-1}\ne n)P(X_{t-1}\ne n)\\\\
= &p (1-P(X_{t-1}= n))
\end{aligned}
$$

æ‰€ä»¥æƒ³è¦æ±‚$E(X_t)$åªéœ€è¦æ±‚$P(X_{t-1}= n)$å³å¯ï¼š

$$
E(X_t) = E(X_{t-1}) +p (1-P(X_{t-1}= n))
$$

ä¸æ–­é€’æ¨å¾—åˆ°ï¼š
$$
E(X_t) = p (1-P(X_{t-1}= n)) + p(1-P(X_{t-2}=n)) + \cdots + p (1-P(X_{1}= n)) + p (1-P(X_{0}= n)) + E(X_0)
$$

æ‰€ä»¥ï¼š
$$
E(X_t) = pt - p\sum_{i=0}^{t-1} P(X_{i}=n)
$$

æ˜¾ç„¶
$$
P(X_i=n) = 0 \quad \forall i\lt n
$$
æ‰€ä»¥ï¼š
$$
E(X_t) = pt - p\sum_{i=n}^{t-1} P(X_{i}=n)
$$

è¿™é‡Œé¢ï¼š
$$
P(X_i = n) = P(X_{i-1}=n) + pP(X_{i-1}=n-1) \quad i\ge n
$$

æ¶‰åŠåˆ°äº†$P(X_{i-1}=n-1)$ï¼Œæ¯”è¾ƒéš¾å¤„ç†ã€‚å¦‚æœé€’å½’æ±‚è§£é‚£ä¹ˆè®¡ç®—é‡å’Œç¬¬ä¸€ç§æ–¹æ³•å·®ä¸å¤šã€‚

æ‰€ä»¥æˆ‘ä»¬è€ƒè™‘ç›´æ¥æ±‚è§£$P(X_i = n)$ï¼Œä¹Ÿå°±æ˜¯$i$ç§’é’Ÿ$n$ä¸ªäººå…¨éƒ¨èµ°æ‰çš„æ¦‚ç‡ã€‚

åªéœ€è¦æ¡ä»¶äºæœ€åä¸€ä¸ªèµ°æ‰çš„äººçš„æ—¶é—´å³å¯ï¼š

$$
P(X_i = n) = \sum_{s=0}^{i-n} C_{i-s-1}^{n-1} p^{n}(1-p)^{i-s-n}
$$

> å‰$i-s-1$ç§’èµ°æ‰äº†$n-1$ä¸ªäººï¼Œç¬¬$i-s$ç§’èµ°æ‰äº†æœ€åä¸€ä¸ªäººï¼Œåé¢çš„$s$ç§’æ— äº‹å‘ç”Ÿã€‚

### åŒé‡æ±‚å’Œä»£ç 

åŒæ ·çš„ï¼Œæˆ‘ä»¬å†™å‡ºä»£ç ï¼š

```python
from math import comb
n, p, t = input().split()
n = int(n)
p = float(p)
t = int(t)
if t <= n:
    print(t * p)
else:
    print(
        t * p
        - p
        * sum(
            sum(
                comb(i - s - 1, n - 1) * p**n * (1 - p) ** (i - s - n)
                for s in range(i - n + 1)
            )
            for i in range(n, t)
        )
    )

```

ä¸è¿‡è¿™ä¸ªä»£ç æ…¢å¾—å¾ˆã€‚

### å•é‡æ±‚å’Œ

æ²¡å…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ç‚¹ç‚¹æ•°å­¦ç­‰ä»·å˜å½¢æŠŠåŒé‡æ±‚å’Œå˜æˆå•å±‚ï¼š
$$
E(X_t) = pt - p\sum_{k=0}^{d-1} (d-k)C_{n+k-1}^{n-1} p^{n}(1-p)^{k}
$$
å…¶ä¸­$d=t-n$

??? question "å’‹å˜çš„ï¼Ÿ"
    æˆ‘ä»¬çš„æœŸæœ›æ˜¯

    $$
    E(X_t) = pt - p\sum_{i=n}^{t-1} \sum_{s=0}^{i-n} C_{i-s-1}^{n-1} p^{n}(1-p)^{i-s-n}
    $$

    è¿™é‡Œé¢æœ‰ä¸€ä¸ªåŒé‡æ±‚å’Œï¼š
    $$
    S = \sum_{i=n}^{t-1} \sum_{s=0}^{i-n} C_{i-s-1}^{n-1} p^{n}(1-p)^{i-s-n}
    $$

    **æ³¨æ„åˆ°åé¢çš„æ±‚å’Œåªå’Œ$i-s$ç›¸å…³ã€‚**ä¸ºäº†ç®€åŒ–è®°å·ï¼Œæˆ‘ä»¬åšä¸€äº›æ¢å…ƒã€‚

    é¦–å…ˆæˆ‘ä»¬åšå˜é‡ä»£æ¢ï¼š$d = t-n$ï¼Œé‚£ä¹ˆï¼š
    $$
    S = \sum_{i=n}^{n+d-1} \sum_{s=0}^{i-n} C_{i-s-1}^{n-1} p^{n}(1-p)^{i-s-n}
    $$

    å†ä»¤$j = i-n$å¾—åˆ°ï¼š
    $$
    S = \sum_{j=0}^{d-1} \sum_{s=0}^{j} C_{j+n-s-1}^{n-1} p^{n}(1-p)^{j-s}
    $$
    è§‚å¯Ÿåˆ°åé¢çš„æ±‚å’Œå®é™…ä¸Šåªå’Œ$j-s$æœ‰å…³ç³»ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠåŒé‡æ±‚å’Œå˜ä¸ºå…³äº$k = j-s$çš„å•é‡æ±‚å’Œã€‚

    $k$çš„å–å€¼ä¸º$0,1,\cdots, d-1$ï¼Œ**é‡æ•°**åˆ†åˆ«ä¸º$d, d-1, \cdots, 1$ã€‚

    > é‡æ•°çš„è®¡ç®—å¾ˆç®€å•ï¼Œè§‚å¯Ÿä¸€ä¸‹ï¼š
    >
    > |j|0|1|2|...|d-1|
    > |--|--|--|--|--|--|
    > |s|0|0,1|0,1,2|...|0,1,...,d-1|
    > |j-s|0|1,0|2,1,0|...|d-1,d-2,...,0|
    >
    > å°±çŸ¥é“ï¼Œ$j-s=k$å‡ºç°çš„æ¬¡æ•°æ˜¯$d-k$

    æ‰€ä»¥ï¼š

    $$
    S = \sum_{k=0}^{d-1} (d-k)C_{n+k-1}^{n-1} p^{n}(1-p)^{k}
    $$

    è¿™å°±æŠŠåŒé‡æ±‚å’Œå˜æˆäº†å•é‡ã€‚

```python
from math import comb
n, p, t = input().split()
n = int(n)
p = float(p)
t = int(t)
if t <= n:
    print(t * p)
else:
    d = t - n
    print(
        t * p
        - p
        * sum(
            (d - k) * comb(n + k - 1, n-1) * p**n * (1 - p) ** k
            for k in range(d)
        )
    )
```

è¿™ä¸‹ä»£ç å¾ˆå¿«äº†ï¼Œä½†æ˜¯æ•°å­—å¾ˆå¤§çš„æ—¶å€™ä¼šæœ‰`OverflowError`ï¼Œä¸€ä¸ªè¶…å¤§çš„æ•´æ•°ä¹˜ä»¥æµ®ç‚¹æ•°æ˜¯ä¼šæœ‰é—®é¢˜çš„ï¼Œæ¼ã€‚

### æ•°å€¼å®‰å…¨

ä½†æ˜¯æ²¡æœ‰å…³ç³»ï¼Œæˆ‘ä»¬å†åŠ å…¥ä¸€ç‚¹ç‚¹æ•°å€¼è®¡ç®—çš„å°æŠ€å·§ï¼Œå…ˆå–å¯¹æ•°å†åšæŒ‡æ•°ã€‚è¿™æ ·å°±ä¸ä¼šoverflowäº†ï¼š

```python
from math import comb, log, exp
n, p, t = input().split()
n = int(n)
p = float(p)
t = int(t)
if t <= n:
    print(t * p)
else:
    d = t - n
    # è¦å–å¯¹æ•°äº†ï¼Œæ‰€ä»¥ç‰¹æ®Šæƒ…å†µæ’é™¤ä¸€ä¸‹
    if p == 1:
        print(n)
    elif p == 0:
        print(0)
    else:
        print(
            t * p
            - p
            * sum(
                exp(
                    log(d - k)
                    + log(comb(n + k - 1, n - 1))
                    + n * log(p)
                    + k * log(1 - p)
                )
                for k in range(d)
            )
        )
```

### AC

ç»ˆäºï¼Œdpç®—æ³•å’Œç›´æ¥ç”¨ç»„åˆæ•°çš„è§£æ³•éƒ½ACäº†ğŸ˜­

å‰è€…æ˜¯å¸¸è§„ç®—æ³•ï¼Œæ—¶é—´å¤æ‚åº¦å’Œç©ºé—´å¤æ‚åº¦è¿˜å¯ä»¥ã€‚åè€…æ²¡æœ‰ç©ºé—´å¤æ‚åº¦ï¼Œæ—¶é—´å¤æ‚åº¦ä¹Ÿå¾ˆä½âœŒï¸

![](assets/2025-05-29-02-39-24.png)

è¯¥ç¡è§‰äº†ğŸ˜´
